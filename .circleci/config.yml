version: 2
jobs:
  build-casval-ui:
    docker:
      - image: circleci/node:10.16.0-stretch
    steps:
      - checkout
      - run: mkdir -p tmp/ui
      - run:
          name: Instsall dependency package
          command: |
            cd ui
            npm ci
      - run:
          name: Build casval-ui
          command: |
            cd ui
            npm run build
            mv dist/ /home/circleci/project/tmp/ui/dist
      - persist_to_workspace:
          root: /home/circleci/project/tmp/
          paths:
            - ui/


  build-casval-admin-ui:
    docker:
      - image: circleci/node:10.16.0-stretch
    steps:
      - checkout
      - run: mkdir -p tmp/admin-ui
      - run:
          name: Instsall dependency package
          command: |
            cd admin-ui
            npm ci
      - run:
          name: Build casval-ui
          command: |
            cd admin-ui
            npm run build
            mv dist/ /home/circleci/project/tmp/admin-ui/dist
      - persist_to_workspace:
          root: /home/circleci/project/tmp/
          paths:
            - admin-ui/
  deploy:
    docker:
      - image: google/cloud-sdk
    steps:
      - checkout
      - attach_workspace:
          at: ./tmp
      - run:
          name: Auth Google API
          command: |
            echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
            gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
            gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
      - run:
          name: Add Sops
          command: |
            curl -LO https://github.com/mozilla/sops/releases/download/3.3.1/sops-3.3.1.linux
            chmod +x sops-3.3.1.linux
            mv sops-3.3.1.linux ./rem/sops
      - run:
          name: Deploy casval-rem
          command: |
            # Need secret file for application default credential
            echo $GCLOUD_SERVICE_KEY > secret.json
            export GOOGLE_APPLICATION_CREDENTIALS=$PWD/secret.json

            cd ./rem/
            ./sops --decrypt config.enc.env > config.env
            gcloud -q app deploy
      - run:
          name: Deploy casval-ui
          command: |
            cp -R ./tmp/ui/dist/ ./ui/dist/
            cd ./ui/
            gcloud -q app deploy
      - run:
          name: Deploy casval-admin-ui
          command: |
            cp -R ./tmp/admin-ui/dist/ ./admin-ui/dist/
            cd ./admin-ui/
            gcloud -q app deploy
      - run:
          name: Deploy Dispatch
          command: |
            gcloud -q app deploy dispatch.yaml
      - run:
          name: Deploy CronJobs
          command: |
            gcloud -q app deploy cron.yaml

workflows:
  version: 2
  test-and-build:
    jobs:
      - build-casval-ui
      - build-casval-admin-ui
      - deploy:
          requires:
            - build-casval-ui
            - build-casval-admin-ui
