<template>
  <div class="col">
    <div class="card">
      <div class="card-body">
        <div class="h5 mb-3">
          {{ $t('vulnerability.list') }}
        </div>
        <div>
          <hr />
          <div class="d-flex flex-row my-4">
            <div class="pl-2 pr-2">
              <input
                type="text"
                class="form-control form-control-sm"
                v-model="keyword"
                :placeholder="$t('vulnerability.search')"
                @blur="loadVulnerabilities(1)"
                @keyup.enter="loadVulnerabilities(1)"
              />
            </div>

            <div class="pr-2">
              <select class="form-control form-control-sm" v-model="fixRequired" @change="loadVulnerabilities(1)">
                <option value="">{{ $t('vulnerability.choose-fix-required') }}</option>
                <option value="REQUIRED">{{ $t('vulnerability.fix-required-required') }}</option>
                <option value="RECOMMENDED">{{ $t('vulnerability.fix-required-recommended') }}</option>
                <option value="OPTIONAL">{{ $t('vulnerability.fix-required-optional') }}</option>
                <option value="UNDEFINED">{{ $t('vulnerability.fix-required-undefined') }}</option>
              </select>
            </div>

            <div class="ml-auto">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary mr-2"
                :disabled="currentPage == 1"
                @click="loadVulnerabilities(currentPage - 1)"
              >
                &laquo; {{ $t('vulnerability.previous') }}
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary mr-2"
                :disabled="loadedCount < displayCount"
                @click="loadVulnerabilities(currentPage + 1)"
              >
                {{ $t('vulnerability.next') }} &raquo;
              </button>
            </div>
          </div>
          <table class="table table-sm table-hover mb-0">
            <thead>
              <tr>
                <th scope="col">{{ $t('vulnerability.id') }}</th>
                <th scope="col">{{ $t('vulnerability.title') }}</th>
                <th style="white-space:nowrap;" scope="col">{{ $t('vulnerability.fix-required') }}</th>
                <th style="white-space:nowrap;" scope="col">{{ $t('vulnerability.correction-method') }}</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(vuln, index) in vulnerabilities" :key="index">
                <td>{{ displayOid(vuln.oid) }}</td>
                <td>
                  <span v-tooltip="{ content: displayDescription(vuln.description) }">{{ vuln.name }}</span>
                </td>
                <td style="white-space:nowrap;">
                  <div
                    class="form-check form-check-inline"
                    v-for="(candidate, candidateIndex) in fixRequiredCandidates"
                    :key="candidateIndex"
                  >
                    <input
                      class="form-check-input"
                      type="radio"
                      :name="`radio-${index}`"
                      :id="`radio-${index}-${candidateIndex}`"
                      @change="updateFixRequired(vuln.oid, candidate)"
                      :checked="vuln.fix_required === candidate"
                    />
                    <label class="form-check-label" :for="`radio-${index}-${candidateIndex}`">{{
                      $t(`vulnerability.fix-required-${candidate.toLowerCase()}`)
                    }}</label>
                  </div>
                </td>
                <td style="white-space:nowrap;">
                  <modal-advice
                    :index="index"
                    :modal-id="`modal-advice-${displayOid(vuln.oid)}`"
                    :oid="vuln.oid"
                    :advice="vuln.advice"
                    :vulnerability-api-client="vulnerabilityApiClient"
                    @adviceUpdated="updateAdvice"
                  />
                  <button
                    v-tooltip="{ content: vuln.advice }"
                    class="btn btn-sm btn-secondary float-right"
                    @click.prevent="showAdviceModal(`modal-advice-${displayOid(vuln.oid)}`)"
                  >
                    {{ $t('vulnerability.describe') }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <hr class="mt-1 mb-3" />
        </div>
        <div class="float-right">
          <button type="button" class="btn btn-sm btn-outline-secondary mr-2" @click="downloadVulnerabilities">
            &#11015; {{ $t('vulnerability.download-all') }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import $ from 'jquery';
import ModalAdvice from './ModalAdvice.vue';

export default {
  name: 'VulnerabilityList',
  props: {
    vulnerabilityApiClient: {
      type: Function,
      required: true
    }
  },
  components: {
    ModalAdvice
  },
  data() {
    return {
      fixRequired: '',
      keyword: '',
      vulnerabilities: [],
      errorMessage: '',
      currentPage: 1,
      displayCount: 50,
      loadedCount: 0,
      fixRequiredCandidates: ['REQUIRED', 'RECOMMENDED', 'OPTIONAL', 'UNDEFINED']
    };
  },
  watch: {
    keyword() {
      if (this.incrementalSearchTimer) {
        clearTimeout(this.incrementalSearchTimer);
      }
      this.incrementalSearchTimer = setTimeout(() => this.loadVulnerabilities(1), 500);
    }
  },
  methods: {
    showAdviceModal: function showAdviceModal(modalId) {
      $(`#${modalId}`).modal('show');
    },
    updateAdvice: function updateAdvice(index, advice) {
      this.vulnerabilities[index].advice = advice;
    },
    displayOid: function displayOid(oid) {
      return oid.replace(process.env.VUE_APP_OPENVAS_OID_PREFIX, '');
    },
    displayDescription: function displayDescription(description) {
      const text = `${description}|`;

      return text
        .replace(/cvss_base_vector=[^|]*\|/g, '')
        .replace(/qod_type=[^|]*\|/g, '')
        .replace(/solution_type=[^|]*\|/g, '')
        .replace(/summary=/, '')
        .replace(/\|$/, '')
        .replace(/\|/, '\n\n');
    },
    updateFixRequired: async function updateFixRequired(oid, fixRequired) {
      try {
        const res = await this.vulnerabilityApiClient.patch(`/${oid}/`, { fix_required: fixRequired });
        switch (res.status) {
          case 200: {
            break;
          }
          default: {
            this.errorMessage = this.$i18n.t('vulnerability.error-update');
          }
        }
      } catch (e) {
        this.errorMessage = this.$i18n.t('vulnerability.error-update');
      }
    },
    getTimezoneOffset: function getTimezoneOffset() {
      const date = new Date();
      return -1 * date.getTimezoneOffset();
    },
    downloadVulnerabilities: async function downloadVulnerabilities() {
      try {
        const offset = this.getTimezoneOffset();
        const res = await this.vulnerabilityApiClient.get(
          `/download/?tz_offset=${offset}&fix_required=${this.fixRequired}&keyword=${this.keyword}`
        );
        switch (res.status) {
          case 200: {
            const csv = res.data;
            const mime = 'text/csv';
            const filename = 'casval-vulnerability-list.csv';
            const blob = new Blob([csv], { type: mime });
            if (window.navigator.msSaveBlob) {
              window.navigator.msSaveBlob(blob, filename); // IE
            } else if (window.URL && window.URL.createObjectURL) {
              const a = document.createElement('a');
              a.href = window.URL.createObjectURL(blob);
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
            }
            break;
          }
          default:
            this.errorMessage = this.$i18n.t('vulnerability.error-loading');
        }
      } catch (e) {
        this.errorMessage = this.$i18n.t('vulnerability.error-loading');
      }
    },
    loadVulnerabilities: async function loadVulnerabilities(page) {
      try {
        const res = await this.vulnerabilityApiClient.get(
          `/?fix_required=${this.fixRequired}&keyword=${this.keyword}&page=${page}&count=${this.displayCount}`
        );
        switch (res.status) {
          case 200:
          case 304:
            this.loadedCount = res.data.length;
            this.vulnerabilities = res.data;
            this.currentPage = page;
            break;
          default:
            this.errorMessage = this.$i18n.t('vulnerability.error-loading');
        }
      } catch (e) {
        this.errorMessage = this.$i18n.t('vulnerability.error-loading');
      }
    }
  },
  mounted: function mounted() {
    this.loadVulnerabilities(this.currentPage);
  }
};
</script>
<style lang="scss">
.tooltip {
  &[aria-hidden='true'] {
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.15s, visibility 0.15s;
  }

  .tooltip-inner {
    max-width: 60rem;
    text-align: left;
  }

  &[aria-hidden='false'] {
    visibility: visible;
    opacity: 1;
    transition: opacity 0.15s;
  }

  &.popover {
    $color: #f9f9f9;

    .popover-inner {
      background: $color;
      color: red;
      padding: 24px;
      border-radius: 5px;
      box-shadow: 0 5px 30px rgba(black, 0.1);
    }

    .popover-arrow {
      border-color: $color;
    }
  }

  display: block !important;
  z-index: 2000;
}
</style>
